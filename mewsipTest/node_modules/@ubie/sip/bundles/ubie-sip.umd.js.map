{"version":3,"file":"ubie-sip.umd.js","sources":["ng://@ubie/sip/lib/interfaces/sip-config.ts","ng://@ubie/sip/lib/services/sip.service.ts"],"sourcesContent":["export interface SipConfig {\n    Uri:string;\n    UserName:string;\n    Password:string;\n    WebsocketUrl:string;\n    DisplayName:string;\n}\n","import { Injectable, EventEmitter } from '@angular/core';\nimport { InviteServerContext, InviteClientContext } from 'sip.js/lib/Session';\nimport { UA } from 'sip.js/lib/UA';\nimport { SessionDescriptionHandler } from 'sip.js/lib/session-description-handler';\nimport { SipConfig } from '../interfaces/sip-config';\nimport { Observable } from 'rxjs';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class SipService {\n\n  //events\n\n  //this event gets triggered when the user is registered to the sip server\n  OnRegistered: EventEmitter<boolean>;\n\n  //this event is triggered when we recieve a call\n  OnIncommingCall: EventEmitter<string>;\n\n  //this event is triggered when the media stream is ready to be attached to a <video></video> tag it should be added to the src and then call play()\n  OnMediaRecieved: EventEmitter<MediaStream>;\n\n  //properties\n  private UserAgent:UA;\n\n  private IncommingCallSession:InviteServerContext;\n\n  private InCall:boolean;\n\n  constructor() { }\n\n\n  //accept an incomming call\n  acceptCall()\n  {\n    if(this.IncommingCallSession != undefined)\n    {\n      this.IncommingCallSession.accept();\n    }\n  }\n\n  //refuse a call thats incomming\n  refuseCall()\n  {\n    if(this.IncommingCallSession != undefined)\n    {\n      this.IncommingCallSession.close();\n    }\n  }\n\n  ///set the config for the sip, makes a user agent that will be used to recieve calls and more\n  setConfig(config:SipConfig)\n  {\n     \n      //make the options\n      var options: UA.Options = {\n        uri: config.Uri,\n        authorizationUser: config.UserName,\n        displayName: config.DisplayName,\n        transportOptions: {\n          wsServers: [config.WebsocketUrl]\n        },\n        password: config.Password\n  \n      };\n      //create the client\n      this.UserAgent = new UA(options); \n  }\n\n  //register the events  on the user agent were interested in\n  private registerAgentEvents()\n  {\n      this.UserAgent.on('invite',(session:InviteServerContext) => this.inviteCallBack(session));\n      this.UserAgent.on('registrationFailed',(response?: any,cause?: any) => this.registerFailedCallBack(response,cause));\n      this.UserAgent.on('registered',(response?: any) => this.registeredCallBack(response));\n  }\n\n  private registeredCallBack(response?: any)\n  {\n    if(this.OnRegistered != undefined)\n    {\n      this.OnRegistered.emit(true);\n    }\n  }\n\n  private registerFailedCallBack(response?: any,reason?: any)\n  {\n    if(this.OnRegistered != undefined)\n    {\n      this.OnRegistered.emit(false);\n    }\n  }\n\n  private inviteCallBack(session:InviteServerContext)\n  {\n    if(session != undefined)\n    {\n      this.registerInviteEvents(session);\n      this.IncommingCallSession = session;    \n      this.OnIncommingCall.next(session.contact);\n    }\n  }\n\n  private registerInviteEvents(session:InviteServerContext)\n  {\n     session.on('trackAdded', () => this.trackAddedCallback())\n  }\n\n  private trackAddedCallback() : InviteServerContext\n  {\n    //check if the session isn't undefined\n    if(this.IncommingCallSession != undefined)\n    {\n\n      //get the peerConnection\n      var peerConnection = this.IncommingCallSession.sessionDescriptionHandler['peerConnection'];\n\n      //make media\n      let media = new MediaStream();\n\n       //get audio and video track from remote\n      peerConnection.getReceivers().forEach(function (receiver) {\n        media.addTrack(receiver.track);\n      });\n\n      this.OnMediaRecieved.emit(media);\n\n\n      return this.IncommingCallSession;\n    }\n  }\n\n}\n"],"names":["UA","Injectable"],"mappings":"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"}
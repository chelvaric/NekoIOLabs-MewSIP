{"version":3,"file":"ubie-sip.js","sources":["ng://@ubie/sip/lib/interfaces/sip-config.ts","ng://@ubie/sip/lib/services/sip.service.ts"],"sourcesContent":["export interface SipConfig {\n    Uri:string;\n    UserName:string;\n    Password:string;\n    WebsocketUrl:string;\n    DisplayName:string;\n}\n","import { Injectable, EventEmitter } from '@angular/core';\nimport { InviteServerContext, InviteClientContext } from 'sip.js/lib/Session';\nimport { UA } from 'sip.js/lib/UA';\nimport { SessionDescriptionHandler } from 'sip.js/lib/session-description-handler';\nimport { SipConfig } from '../interfaces/sip-config';\nimport { Observable } from 'rxjs';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class SipService {\n\n  //events\n\n  //this event gets triggered when the user is registered to the sip server\n  OnRegistered: EventEmitter<boolean>;\n\n  //this event is triggered when we recieve a call\n  OnIncommingCall: EventEmitter<string>;\n\n  //this event is triggered when the media stream is ready to be attached to a <video></video> tag it should be added to the src and then call play()\n  OnMediaRecieved: EventEmitter<MediaStream>;\n\n  //properties\n  private UserAgent:UA;\n\n  private IncommingCallSession:InviteServerContext;\n\n  private InCall:boolean;\n\n  constructor() { }\n\n\n  //accept an incomming call\n  acceptCall()\n  {\n    if(this.IncommingCallSession != undefined)\n    {\n      this.IncommingCallSession.accept();\n    }\n  }\n\n  //refuse a call thats incomming\n  refuseCall()\n  {\n    if(this.IncommingCallSession != undefined)\n    {\n      this.IncommingCallSession.close();\n    }\n  }\n\n  ///set the config for the sip, makes a user agent that will be used to recieve calls and more\n  setConfig(config:SipConfig)\n  {\n     \n      //make the options\n      var options: UA.Options = {\n        uri: config.Uri,\n        authorizationUser: config.UserName,\n        displayName: config.DisplayName,\n        transportOptions: {\n          wsServers: [config.WebsocketUrl]\n        },\n        password: config.Password\n  \n      };\n      //create the client\n      this.UserAgent = new UA(options); \n  }\n\n  //register the events  on the user agent were interested in\n  private registerAgentEvents()\n  {\n      this.UserAgent.on('invite',(session:InviteServerContext) => this.inviteCallBack(session));\n      this.UserAgent.on('registrationFailed',(response?: any,cause?: any) => this.registerFailedCallBack(response,cause));\n      this.UserAgent.on('registered',(response?: any) => this.registeredCallBack(response));\n  }\n\n  private registeredCallBack(response?: any)\n  {\n    if(this.OnRegistered != undefined)\n    {\n      this.OnRegistered.emit(true);\n    }\n  }\n\n  private registerFailedCallBack(response?: any,reason?: any)\n  {\n    if(this.OnRegistered != undefined)\n    {\n      this.OnRegistered.emit(false);\n    }\n  }\n\n  private inviteCallBack(session:InviteServerContext)\n  {\n    if(session != undefined)\n    {\n      this.registerInviteEvents(session);\n      this.IncommingCallSession = session;    \n      this.OnIncommingCall.next(session.contact);\n    }\n  }\n\n  private registerInviteEvents(session:InviteServerContext)\n  {\n     session.on('trackAdded', () => this.trackAddedCallback())\n  }\n\n  private trackAddedCallback() : InviteServerContext\n  {\n    //check if the session isn't undefined\n    if(this.IncommingCallSession != undefined)\n    {\n\n      //get the peerConnection\n      var peerConnection = this.IncommingCallSession.sessionDescriptionHandler['peerConnection'];\n\n      //make media\n      let media = new MediaStream();\n\n       //get audio and video track from remote\n      peerConnection.getReceivers().forEach(function (receiver) {\n        media.addTrack(receiver.track);\n      });\n\n      this.OnMediaRecieved.emit(media);\n\n\n      return this.IncommingCallSession;\n    }\n  }\n\n}\n"],"names":[],"mappings":"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"}